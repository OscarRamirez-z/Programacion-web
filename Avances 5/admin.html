<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GODS GYM - Panel Administrador</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        header {
            background-color: black;
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logo {
            font-size: 35px;
            font-weight: bold;
            color: red;
            margin-bottom: 10px;
        }

        .info-admin {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .badge-admin {
            background-color: red;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .boton-cerrar-sesion {
            background-color: #666;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .contenedor-admin {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        h1 {
            text-align: center;
            color: black;
            font-size: 35px;
            margin-bottom: 40px;
        }

        .pestanas-admin {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
        }

        .pestana-admin {
            padding: 15px 30px;
            background-color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .pestana-admin.activa {
            color: red;
            border-bottom-color: red;
        }

        .panel {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
        }

        .panel.activo {
            display: block;
        }

        .estadisticas {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-numero {
            font-size: 40px;
            font-weight: bold;
            color: red;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #ccc;
        }

        .tabla-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background-color: black;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background-color: #f8f8f8;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-pendiente {
            background-color: #fff9e6;
            color: #cc8800;
        }

        .badge-pagado {
            background-color: #e6ffe6;
            color: #00aa00;
        }

        .badge-usuario {
            background-color: #e6f2ff;
            color: #0066cc;
        }

        .badge-admin-rol {
            background-color: #ffe6e6;
            color: #cc0000;
        }

        .boton-accion {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 5px;
        }

        .boton-pagar {
            background-color: #00aa00;
            color: white;
        }

        .boton-cancelar {
            background-color: #cc0000;
            color: white;
        }

        .boton-admin {
            background-color: red;
            color: white;
        }

        .sin-datos {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .botones-navegacion {
            margin-top: 30px;
            text-align: center;
        }

        .boton-nav {
            background-color: #666;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .mensaje-exito {
            background-color: #e6ffe6;
            color: #00aa00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #00aa00;
        }

        footer {
            background-color: black;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 60px;
        }

        .cargando {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .acceso-denegado {
            text-align: center;
            padding: 60px 20px;
            background-color: white;
            margin: 40px auto;
            max-width: 600px;
            border-radius: 10px;
        }

        .acceso-denegado h2 {
            color: red;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">GODS GYM</div>
        <p style="color: white; margin-top: 10px;">Panel de Administración</p>
        <div class="info-admin">
            <span class="badge-admin">ADMIN</span>
            <button class="boton-cerrar-sesion" onclick="cerrarSesion()">Cerrar Sesión</button>
        </div>
    </header>

    <div class="cargando" id="cargando">
        Verificando permisos...
    </div>

    <div class="acceso-denegado" id="acceso-denegado" style="display: none;">
        <h2>🚫 Acceso Denegado</h2>
        <p>No tienes permisos de administrador para acceder a esta página.</p>
        <a href="index.html" class="boton-nav">Volver al Inicio</a>
    </div>

    <div class="contenedor-admin" id="contenedor-admin" style="display: none;">
        <h1>Panel de Administración</h1>

        <div class="estadisticas">
            <div class="stat-card">
                <div class="stat-numero" id="stat-usuarios">0</div>
                <div class="stat-label">Usuarios Registrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero" id="stat-reservas">0</div>
                <div class="stat-label">Reservas Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero" id="stat-pendientes">0</div>
                <div class="stat-label">Pagos Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero" id="stat-ingresos">$0</div>
                <div class="stat-label">Ingresos (Pagados)</div>
            </div>
        </div>

        <div class="pestanas-admin">
            <button class="pestana-admin activa" onclick="cambiarPanel('reservas')">Reservas</button>
            <button class="pestana-admin" onclick="cambiarPanel('usuarios')">Usuarios</button>
            <button class="pestana-admin" onclick="cambiarPanel('clases')">Clases</button>
        </div>

        <div class="mensaje-exito" id="mensaje-exito"></div>

        <div class="panel activo" id="panel-reservas">
            <h2>Gestión de Reservas</h2>
            <div class="tabla-container">
                <table id="tabla-reservas">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Usuario</th>
                            <th>Plan</th>
                            <th>Precio</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="sin-datos">Cargando reservas...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel" id="panel-usuarios">
            <h2>Gestión de Usuarios</h2>
            <div class="tabla-container">
                <table id="tabla-usuarios">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Fecha Registro</th>
                            <th>Rol</th>
                            <th>Membresías</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="sin-datos">Cargando usuarios...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel" id="panel-clases">
            <h2>Gestión de Clases Grupales</h2>
            <div class="tabla-container">
                <table id="tabla-clases">
                    <thead>
                        <tr>
                            <th>Clase</th>
                            <th>Horario</th>
                            <th>Instructor</th>
                            <th>Inscritos</th>
                            <th>Cupo Máximo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="sin-datos">Cargando clases...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="botones-navegacion">
            <a href="index.html" class="boton-nav">Volver al Inicio</a>
        </div>
    </div>

    <footer>
        <p>Donde los dioses entrenan</p>
        <p>Calle 7 #7-77, Barrio Centro | +57 3053797024 | u20241221201@usco.edu.co</p>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCAy0wZNxxVS0COcQIrALO3A7a75yu2c7k",
            authDomain: "gods-gym.firebaseapp.com",
            projectId: "gods-gym",
            storageBucket: "gods-gym.firebasestorage.app",
            messagingSenderId: "1078850723311",
            appId: "1:1078850723311:web:ece9ce88e9b64b49efea1a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let esAdmin = false;
        let reservasData = [];
        let usuariosData = [];

        window.cerrarSesion = async function() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                alert('Error al cerrar sesión');
            }
        };

        function mostrarMensaje(texto) {
            const mensaje = document.getElementById('mensaje-exito');
            mensaje.textContent = texto;
            mensaje.style.display = 'block';
            setTimeout(() => {
                mensaje.style.display = 'none';
            }, 3000);
        }

        window.cambiarPanel = function(panel) {
            document.querySelectorAll('.pestana-admin').forEach(p => p.classList.remove('activa'));
            event.target.classList.add('activa');

            document.querySelectorAll('.panel').forEach(p => p.classList.remove('activo'));
            document.getElementById(`panel-${panel}`).classList.add('activo');
        };

        async function cargarEstadisticas() {
            const usuariosSnap = await getDocs(collection(db, 'usuarios'));
            document.getElementById('stat-usuarios').textContent = usuariosSnap.size;

            const reservasSnap = await getDocs(collection(db, 'reservas'));
            document.getElementById('stat-reservas').textContent = reservasSnap.size;

            let pendientes = 0;
            let ingresoTotal = 0;

            reservasSnap.forEach((doc) => {
                const reserva = doc.data();
                if (reserva.estado === 'pendiente') {
                    pendientes++;
                } else if (reserva.estado === 'pagado') {
                    const precio = parseInt(reserva.precio.replace('.', ''));
                    ingresoTotal += precio;
                }
            });

            document.getElementById('stat-pendientes').textContent = pendientes;
            document.getElementById('stat-ingresos').textContent = `$${ingresoTotal.toLocaleString()}`;
        }

        async function cargarReservas() {
            const tbody = document.querySelector('#tabla-reservas tbody');
            tbody.innerHTML = '';

            const reservasSnap = await getDocs(collection(db, 'reservas'));
            reservasData = [];

            if (reservasSnap.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="sin-datos">No hay reservas registradas</td></tr>';
                return;
            }

            for (const docSnap of reservasSnap.docs) {
                const reserva = docSnap.data();
                reservasData.push({ id: docSnap.id, ...reserva });

                const estadoBadge = reserva.estado === 'pagado' 
                    ? '<span class="badge badge-pagado">Pagado</span>'
                    : '<span class="badge badge-pendiente">Pendiente</span>';

                const botonesAccion = reserva.estado === 'pendiente'
                    ? `<button class="boton-accion boton-pagar" onclick="marcarPagado('${docSnap.id}')">Marcar Pagado</button>
                       <button class="boton-accion boton-cancelar" onclick="eliminarReserva('${docSnap.id}', '${reserva.usuarioId}', '${reserva.numeroReserva}')">Eliminar</button>`
                    : `<button class="boton-accion boton-cancelar" onclick="eliminarReserva('${docSnap.id}', '${reserva.usuarioId}', '${reserva.numeroReserva}')">Eliminar</button>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${reserva.numeroReserva}</td>
                        <td>${reserva.nombreCompleto}</td>
                        <td>${reserva.planNombre}</td>
                        <td>$${reserva.precio}</td>
                        <td>${reserva.fechaMostrar}</td>
                        <td>${estadoBadge}</td>
                        <td>${botonesAccion}</td>
                    </tr>
                `;
            }
        }

        async function cargarUsuarios() {
            const tbody = document.querySelector('#tabla-usuarios tbody');
            tbody.innerHTML = '';

            const usuariosSnap = await getDocs(collection(db, 'usuarios'));
            usuariosData = [];

            if (usuariosSnap.empty) {
                tbody.innerHTML = '<tr><td colspan="6" class="sin-datos">No hay usuarios registrados</td></tr>';
                return;
            }

            usuariosSnap.forEach((doc) => {
                const usuario = doc.data();
                usuariosData.push({ id: doc.id, ...usuario });

                const rolBadge = usuario.rol === 'admin'
                    ? '<span class="badge badge-admin-rol">Admin</span>'
                    : '<span class="badge badge-usuario">Usuario</span>';

                const fecha = usuario.fechaRegistro 
                    ? new Date(usuario.fechaRegistro).toLocaleDateString('es-ES')
                    : '-';

                const membresias = usuario.membresias ? usuario.membresias.length : 0;

                const botonAdmin = usuario.rol !== 'admin'
                    ? `<button class="boton-accion boton-admin" onclick="hacerAdmin('${doc.id}')">Hacer Admin</button>`
                    : '-';

                tbody.innerHTML += `
                    <tr>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>${fecha}</td>
                        <td>${rolBadge}</td>
                        <td>${membresias}</td>
                        <td>${botonAdmin}</td>
                    </tr>
                `;
            });
        }

        async function cargarClases() {
            const tbody = document.querySelector('#tabla-clases tbody');
            tbody.innerHTML = '';

            const clasesSnap = await getDocs(collection(db, 'clases'));

            if (clasesSnap.empty) {
                tbody.innerHTML = '<tr><td colspan="6" class="sin-datos">No hay clases registradas</td></tr>';
                return;
            }

            clasesSnap.forEach((doc) => {
                const clase = doc.data();
                const inscritos = clase.inscritos ? clase.inscritos.length : 0;
                const estado = inscritos >= clase.cupoMax 
                    ? '<span class="badge badge-pendiente">Lleno</span>'
                    : '<span class="badge badge-pagado">Disponible</span>';

                tbody.innerHTML += `
                    <tr>
                        <td>${clase.nombre}</td>
                        <td>${clase.horario}</td>
                        <td>${clase.instructor}</td>
                        <td>${inscritos}</td>
                        <td>${clase.cupoMax}</td>
                        <td>${estado}</td>
                    </tr>
                `;
            });
        }

        window.marcarPagado = async function(reservaId) {
            if (!confirm('¿Marcar esta reserva como pagada?')) return;

            try {
                await updateDoc(doc(db, 'reservas', reservaId), {
                    estado: 'pagado'
                });

                // para actualizar el array de membresiass del usuario
                const reserva = reservasData.find(r => r.id === reservaId);
                if (reserva) {
                    const usuarioDoc = await getDoc(doc(db, 'usuarios', reserva.usuarioId));
                    if (usuarioDoc.exists()) {
                        const usuario = usuarioDoc.data();
                        const membresias = usuario.membresias.map(m => {
                            if (m.numeroReserva === reserva.numeroReserva) {
                                return { ...m, estado: 'pagado' };
                            }
                            return m;
                        });
                        await updateDoc(doc(db, 'usuarios', reserva.usuarioId), { membresias });
                    }
                }

                mostrarMensaje('Reserva marcada como pagada');
                await cargarReservas();
                await cargarEstadisticas();
            } catch (error) {
                alert('Error al actualizar reserva');
            }
        };

        window.eliminarReserva = async function(reservaId, usuarioId, numeroReserva) {
            if (!confirm('¿Estás seguro de ELIMINAR permanentemente esta reserva de la base de datos?')) return;

            try {
                console.log('Eliminando reserva:', reservaId);
                
                await deleteDoc(doc(db, 'reservas', reservaId));
                console.log('Reserva eliminada de Firebase');

                try {
                    const usuarioDoc = await getDoc(doc(db, 'usuarios', usuarioId));
                    if (usuarioDoc.exists()) {
                        const usuario = usuarioDoc.data();
                        const membresiasActualizadas = usuario.membresias.filter(
                            m => m.numeroReserva !== numeroReserva
                        );
                        await updateDoc(doc(db, 'usuarios', usuarioId), { 
                            membresias: membresiasActualizadas 
                        });
                        console.log('Membresía eliminada del usuario');
                    }
                } catch (errorUsuario) {
                    console.log('Error al actualizar usuario (no crítico):', errorUsuario);
                }

                mostrarMensaje('✓ Reserva eliminada permanentemente de la base de datos');

                await cargarReservas();
                await cargarEstadisticas();
                
            } catch (error) {
                console.error('Error completo:', error);
                alert('Error al eliminar la reserva: ' + error.message);
            }
        };

        window.hacerAdmin = async function(usuarioId) {
            if (!confirm('¿Otorgar permisos de administrador a este usuario?')) return;

            try {
                await updateDoc(doc(db, 'usuarios', usuarioId), {
                    rol: 'admin'
                });

                mostrarMensaje('Usuario promovido a administrador');
                await cargarUsuarios();
            } catch (error) {
                alert('Error al actualizar usuario');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('cargando').style.display = 'none';

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const usuarioDoc = await getDoc(doc(db, 'usuarios', user.uid));
                
                if (usuarioDoc.exists() && usuarioDoc.data().rol === 'admin') {
                    esAdmin = true;
                    document.getElementById('contenedor-admin').style.display = 'block';
                    
                    await cargarEstadisticas();
                    await cargarReservas();
                    await cargarUsuarios();
                    await cargarClases();
                } else {
                    document.getElementById('acceso-denegado').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('acceso-denegado').style.display = 'block';
            }
        });
    </script>
</body>
</html>